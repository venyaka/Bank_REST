input {
  beats {
    port => 5044
  }

  tcp {
    port => 5000
    codec => json_lines
  }
}

filter {
  # Парсинг JSON-логов от Spring Boot приложения
  if [container][name] =~ /bankcards_backend/ {
    json {
      source => "message"
      target => "log"
      skip_on_invalid_json => true
    }

    # Извлекаем поля из JSON
    if [log][timestamp] {
      date {
        match => ["[log][timestamp]", "ISO8601"]
        target => "@timestamp"
      }
    }

    # Добавляем поля для удобного поиска
    if [log][level] {
      mutate {
        add_field => { "log_level" => "%{[log][level]}" }
      }
    }

    if [log][logger] {
      mutate {
        add_field => { "logger_name" => "%{[log][logger]}" }
      }
    }

    if [log][requestId] {
      mutate {
        add_field => { "request_id" => "%{[log][requestId]}" }
      }
    }

    if [log][userId] {
      mutate {
        add_field => { "user_id" => "%{[log][userId]}" }
      }
    }

    if [log][userEmail] {
      mutate {
        add_field => { "user_email" => "%{[log][userEmail]}" }
      }
    }
  }

  # Удаляем лишние поля
  mutate {
    remove_field => ["agent", "ecs", "host", "input", "tags"]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "bankcards-logs-%{+YYYY.MM.dd}"
  }

  # Для отладки (можно закомментировать в продакшене)
  # stdout {
  #   codec => rubydebug
  # }
}

